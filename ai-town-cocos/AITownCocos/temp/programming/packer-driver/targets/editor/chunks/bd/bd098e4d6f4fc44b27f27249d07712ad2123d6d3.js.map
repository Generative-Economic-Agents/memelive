{"version":3,"sources":["file:///Users/feiwang/cutepet/node_modules/aws-sdk/lib/publisher/index.js"],"names":["_cjsLoader","_req","__cjsMetaURL","_req0","url","define","exports","require","module","__filename","__dirname","util","dgram","stringToBuffer","buffer","toBuffer","MAX_MESSAGE_SIZE","Publisher","options","enabled","port","clientId","address","host","length","substr","messagesInFlight","prototype","fieldsToTrim","UserAgent","SdkException","SdkExceptionMessage","AwsException","AwsExceptionMessage","FinalSdkException","FinalSdkExceptionMessage","FinalAwsException","FinalAwsExceptionMessage","trimFields","event","trimmableFields","Object","keys","i","iLen","field","hasOwnProperty","maxLength","value","eventHandler","ClientId","message","JSON","stringify","publishDatagram","self","client","getClient","send","err","bytes","destroyClient","createSocket","close","_cjsExports","_Publisher"],"mappings":";;;;;;;;;AAAOA,MAAAA,U;;AACkBC,MAAAA,I,iBAAhBC,Y;;AACgBC,MAAAA,K,UAAhBD,Y;;;8BAGHA,Y,GAAe,cAAYE,G;;AACjCJ,MAAAA,UAAU,CAACK,MAAX,CAAkBH,YAAlB,EAAgC,UAAUI,OAAV,EAAmBC,OAAnB,EAA4BC,MAA5B,EAAoCC,UAApC,EAAgDC,SAAhD,EAA2D;AAC3F;AAGC,YAAIC,IAAI,GAAGJ,OAAO,CAAC,SAAD,CAAP,CAAmBI,IAA9B;;AACA,YAAIC,KAAK,GAAGL,OAAO,CAAC,OAAD,CAAnB;;AACA,YAAIM,cAAc,GAAGF,IAAI,CAACG,MAAL,CAAYC,QAAjC;AAEA,YAAIC,gBAAgB,GAAG,OAAO,CAA9B,CAR0F,CAQzD;;AAEjC;AACD;AACA;AACA;AACA;AACA;AACA;AACA;;AACC,iBAASC,SAAT,CAAmBC,OAAnB,EAA4B;AACxB;AACAA,UAAAA,OAAO,GAAGA,OAAO,IAAI,EAArB;AACA,eAAKC,OAAL,GAAeD,OAAO,CAACC,OAAR,IAAmB,KAAlC;AACA,eAAKC,IAAL,GAAYF,OAAO,CAACE,IAAR,IAAgB,KAA5B;AACA,eAAKC,QAAL,GAAgBH,OAAO,CAACG,QAAR,IAAoB,EAApC;AACA,eAAKC,OAAL,GAAeJ,OAAO,CAACK,IAAR,IAAgB,WAA/B;;AACA,cAAI,KAAKF,QAAL,CAAcG,MAAd,GAAuB,GAA3B,EAAgC;AAC5B;AACA,iBAAKH,QAAL,GAAgB,KAAKA,QAAL,CAAcI,MAAd,CAAqB,CAArB,EAAwB,GAAxB,CAAhB;AACH;;AACD,eAAKC,gBAAL,GAAwB,CAAxB;AACH;;AAEDT,QAAAA,SAAS,CAACU,SAAV,CAAoBC,YAApB,GAAmC;AAC/BC,UAAAA,SAAS,EAAE,GADoB;AAE/BC,UAAAA,YAAY,EAAE,GAFiB;AAG/BC,UAAAA,mBAAmB,EAAE,GAHU;AAI/BC,UAAAA,YAAY,EAAE,GAJiB;AAK/BC,UAAAA,mBAAmB,EAAE,GALU;AAM/BC,UAAAA,iBAAiB,EAAE,GANY;AAO/BC,UAAAA,wBAAwB,EAAE,GAPK;AAQ/BC,UAAAA,iBAAiB,EAAE,GARY;AAS/BC,UAAAA,wBAAwB,EAAE;AATK,SAAnC;AAaA;AACD;AACA;AACA;AACA;AACA;;AACCpB,QAAAA,SAAS,CAACU,SAAV,CAAoBW,UAApB,GAAiC,UAASC,KAAT,EAAgB;AAC7C,cAAIC,eAAe,GAAGC,MAAM,CAACC,IAAP,CAAY,KAAKd,YAAjB,CAAtB;;AACA,eAAK,IAAIe,CAAC,GAAG,CAAR,EAAWC,IAAI,GAAGJ,eAAe,CAAChB,MAAvC,EAA+CmB,CAAC,GAAGC,IAAnD,EAAyDD,CAAC,EAA1D,EAA8D;AAC1D,gBAAIE,KAAK,GAAGL,eAAe,CAACG,CAAD,CAA3B;;AACA,gBAAIJ,KAAK,CAACO,cAAN,CAAqBD,KAArB,CAAJ,EAAiC;AAC7B,kBAAIE,SAAS,GAAG,KAAKnB,YAAL,CAAkBiB,KAAlB,CAAhB;AACA,kBAAIG,KAAK,GAAGT,KAAK,CAACM,KAAD,CAAjB;;AACA,kBAAIG,KAAK,IAAIA,KAAK,CAACxB,MAAN,GAAeuB,SAA5B,EAAuC;AACnCR,gBAAAA,KAAK,CAACM,KAAD,CAAL,GAAeG,KAAK,CAACvB,MAAN,CAAa,CAAb,EAAgBsB,SAAhB,CAAf;AACH;AACJ;AACJ;;AACD,iBAAOR,KAAP;AACH,SAbD;AAeA;AACD;AACA;AACA;AACA;;;AACCtB,QAAAA,SAAS,CAACU,SAAV,CAAoBsB,YAApB,GAAmC,UAASV,KAAT,EAAgB;AAC/C;AACAA,UAAAA,KAAK,CAACW,QAAN,GAAiB,KAAK7B,QAAtB;AAEA,eAAKiB,UAAL,CAAgBC,KAAhB;AAEA,cAAIY,OAAO,GAAGtC,cAAc,CAACuC,IAAI,CAACC,SAAL,CAAed,KAAf,CAAD,CAA5B;;AACA,cAAI,CAAC,KAAKpB,OAAN,IAAiBgC,OAAO,CAAC3B,MAAR,GAAiBR,gBAAtC,EAAwD;AACpD;AACA;AACH;;AAED,eAAKsC,eAAL,CAAqBH,OAArB;AACH,SAbD;AAeA;AACD;AACA;AACA;AACA;;;AACClC,QAAAA,SAAS,CAACU,SAAV,CAAoB2B,eAApB,GAAsC,UAASH,OAAT,EAAkB;AACpD,cAAII,IAAI,GAAG,IAAX;AACA,cAAIC,MAAM,GAAG,KAAKC,SAAL,EAAb;AAEA,eAAK/B,gBAAL;AACA,eAAK8B,MAAL,CAAYE,IAAZ,CAAiBP,OAAjB,EAA0B,CAA1B,EAA6BA,OAAO,CAAC3B,MAArC,EAA6C,KAAKJ,IAAlD,EAAwD,KAAKE,OAA7D,EAAsE,UAASqC,GAAT,EAAcC,KAAd,EAAqB;AACvF,gBAAI,EAAEL,IAAI,CAAC7B,gBAAP,IAA2B,CAA/B,EAAkC;AAC9B;AACA6B,cAAAA,IAAI,CAACM,aAAL;AACH;AACJ,WALD;AAMH,SAXD;AAaA;AACD;AACA;AACA;;;AACC5C,QAAAA,SAAS,CAACU,SAAV,CAAoB8B,SAApB,GAAgC,YAAW;AACvC,cAAI,CAAC,KAAKD,MAAV,EAAkB;AACd,iBAAKA,MAAL,GAAc5C,KAAK,CAACkD,YAAN,CAAmB,MAAnB,CAAd;AACH;;AACD,iBAAO,KAAKN,MAAZ;AACH,SALD;AAOA;AACD;AACA;AACA;;;AACCvC,QAAAA,SAAS,CAACU,SAAV,CAAoBkC,aAApB,GAAoC,YAAW;AAC3C,cAAI,KAAKL,MAAT,EAAiB;AACb,iBAAKA,MAAL,CAAYO,KAAZ;AACA,iBAAKP,MAAL,GAAc,KAAK,CAAnB;AACH;AACJ,SALD;;AAOAhD,QAAAA,MAAM,CAACF,OAAP,GAAiB;AACbW,UAAAA,SAAS,EAAEA;AADE,SAAjB,CA9H0F,CAmI3F;;AAEA,2BAAA+C,WAAW,GAAGxD,MAAM,CAACF,OAArB;;AACA2D,QAAAA,UAAU,GAAGzD,MAAM,CAACF,OAAP,CAAeW,SAA5B;AAEC,OAxID,EAwIG,OAAO;AACR,mBAAWhB,IADH;AAER,iBAASE;AAFD,OAAP,CAxIH","sourcesContent":["import _cjsLoader from 'cce:/internal/ml/cjs-loader.mjs';\nimport { __cjsMetaURL as _req} from '../core';\nimport { __cjsMetaURL as _req0} from 'dgram';\nlet _cjsExports;\nlet _Publisher;\nconst __cjsMetaURL = import.meta.url;\n_cjsLoader.define(__cjsMetaURL, function (exports, require, module, __filename, __dirname) {\n// #region ORIGINAL CODE\n\n\n var util = require('../core').util;\n var dgram = require('dgram');\n var stringToBuffer = util.buffer.toBuffer;\n\n var MAX_MESSAGE_SIZE = 1024 * 8; // 8 KB\n\n /**\n  * Publishes metrics via udp.\n  * @param {object} options Paramters for Publisher constructor\n  * @param {number} [options.port = 31000] Port number\n  * @param {string} [options.clientId = ''] Client Identifier\n  * @param {boolean} [options.enabled = false] enable sending metrics datagram\n  * @api private\n  */\n function Publisher(options) {\n     // handle configuration\n     options = options || {};\n     this.enabled = options.enabled || false;\n     this.port = options.port || 31000;\n     this.clientId = options.clientId || '';\n     this.address = options.host || '127.0.0.1';\n     if (this.clientId.length > 255) {\n         // ClientId has a max length of 255\n         this.clientId = this.clientId.substr(0, 255);\n     }\n     this.messagesInFlight = 0;\n }\n\n Publisher.prototype.fieldsToTrim = {\n     UserAgent: 256,\n     SdkException: 128,\n     SdkExceptionMessage: 512,\n     AwsException: 128,\n     AwsExceptionMessage: 512,\n     FinalSdkException: 128,\n     FinalSdkExceptionMessage: 512,\n     FinalAwsException: 128,\n     FinalAwsExceptionMessage: 512\n\n };\n\n /**\n  * Trims fields that have a specified max length.\n  * @param {object} event ApiCall or ApiCallAttempt event.\n  * @returns {object}\n  * @api private\n  */\n Publisher.prototype.trimFields = function(event) {\n     var trimmableFields = Object.keys(this.fieldsToTrim);\n     for (var i = 0, iLen = trimmableFields.length; i < iLen; i++) {\n         var field = trimmableFields[i];\n         if (event.hasOwnProperty(field)) {\n             var maxLength = this.fieldsToTrim[field];\n             var value = event[field];\n             if (value && value.length > maxLength) {\n                 event[field] = value.substr(0, maxLength);\n             }\n         }\n     }\n     return event;\n };\n\n /**\n  * Handles ApiCall and ApiCallAttempt events.\n  * @param {Object} event apiCall or apiCallAttempt event.\n  * @api private\n  */\n Publisher.prototype.eventHandler = function(event) {\n     // set the clientId\n     event.ClientId = this.clientId;\n\n     this.trimFields(event);\n\n     var message = stringToBuffer(JSON.stringify(event));\n     if (!this.enabled || message.length > MAX_MESSAGE_SIZE) {\n         // drop the message if publisher not enabled or it is too large\n         return;\n     }\n\n     this.publishDatagram(message);\n };\n\n /**\n  * Publishes message to an agent.\n  * @param {Buffer} message JSON message to send to agent.\n  * @api private\n  */\n Publisher.prototype.publishDatagram = function(message) {\n     var self = this;\n     var client = this.getClient();\n\n     this.messagesInFlight++;\n     this.client.send(message, 0, message.length, this.port, this.address, function(err, bytes) {\n         if (--self.messagesInFlight <= 0) {\n             // destroy existing client so the event loop isn't kept open\n             self.destroyClient();\n         }\n     });\n };\n\n /**\n  * Returns an existing udp socket, or creates one if it doesn't already exist.\n  * @api private\n  */\n Publisher.prototype.getClient = function() {\n     if (!this.client) {\n         this.client = dgram.createSocket('udp4');\n     }\n     return this.client;\n };\n\n /**\n  * Destroys the udp socket.\n  * @api private\n  */\n Publisher.prototype.destroyClient = function() {\n     if (this.client) {\n         this.client.close();\n         this.client = void 0;\n     }\n };\n\n module.exports = {\n     Publisher: Publisher\n };\n\n\n// #endregion ORIGINAL CODE\n\n_cjsExports = module.exports;\n_Publisher = module.exports.Publisher;\n\n}, () => ({\n  '../core': _req,\n  'dgram': _req0,\n}));\nexport { _cjsExports as default };\nexport { __cjsMetaURL }\n"]}