{"version":3,"sources":["file:///Users/feiwang/workSpace/AITown/cutepet/assets/src/game/scene/WorldMap.ts"],"names":["WorldMap","Layers","Node","Rect","Vec2","ObjDictionary","mGameConfig","sceneManager","LayerEnum","MapGridVO","MapTile","SceneManager","container","_container","gridVO","_gridVO","gridTiles","_gridTiles","constructor","_loadedTiles","layer","Enum","UI_2D","init","createTiles","reset","_instance","Array","col","row","update","instance","camera","parent","camView","cameraView","tiles","getNeedLoadTiles","x","y","loadTiles","vec","focusTarget","position","setPosition","getLayer","DebugLayer","length","arr","key","strKey","containsKey","split","parseInt","loadTile","add","console","log","camX","camY","cellW","cellH","rect","DeviceW","DeviceH","p1","scenePosToGrid","p2","width","height","res","i","j","getNeedLoadTiles1","centerP","gridToScenePos","contains","p"],"mappings":";;;gMASqBA,Q;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AATZC,MAAAA,M,OAAAA,M;AAAQC,MAAAA,I,OAAAA,I;AAAKC,MAAAA,I,OAAAA,I;AAAaC,MAAAA,I,OAAAA,I;;AAC5BC,MAAAA,a;;AACAC,MAAAA,W;;AACEC,MAAAA,Y,iBAAAA,Y;;AACFC,MAAAA,S;;AACAC,MAAAA,S;;AACAC,MAAAA,O;;AACAC,MAAAA,Y;;;;;;;;;yBAEcX,Q,GAAN,MAAMA,QAAN,CACf;AAGqB,YAATY,SAAS,GACpB;AACC,iBAAO,KAAKC,UAAZ;AACA;;AAIgB,YAANC,MAAM,GACjB;AACC,iBAAO,KAAKC,OAAZ;AACA;;AAGmB,YAATC,SAAS,GACpB;AACC,iBAAO,KAAKC,UAAZ;AACA;AAED;AACD;AACA;;;AAGQC,QAAAA,WAAW,GAClB;AAAA,eAzBQL,UAyBR;AAAA,eAlBQE,OAkBR,GAlB4B;AAAA;AAAA,uCAkB5B;AAAA,eAZQE,UAYR;AAAA,eAHQE,YAGR,GAHqC;AAAA;AAAA,+CAGrC;AACC,eAAKN,UAAL,GAAkB,IAAIX,IAAJ,EAAlB;AACM,eAAKW,UAAL,CAAgBO,KAAhB,GAAwBnB,MAAM,CAACoB,IAAP,CAAYC,KAApC;AAA0C;AAC1C,eAAKC,IAAL;AACN;;AAEMA,QAAAA,IAAI,GACX;AACC;AACA;AACA;AACA,eAAKC,WAAL;AACA;;AACMC,QAAAA,KAAK,GAAE;AACbzB,UAAAA,QAAQ,CAAC0B,SAAT,GAAqB,IAArB;AACA;;AAEOF,QAAAA,WAAW,GACnB;AACC,eAAKP,UAAL,GAAkB,IAAIU,KAAJ,EAAlB;;AACA,eAAI,IAAIC,GAAU,GAAC,CAAnB,EAAsBA,GAAG,GAAC,KAAKb,OAAL,CAAaa,GAAvC,EAA4CA,GAAG,EAA/C,EACA;AACC,iBAAKX,UAAL,CAAgBW,GAAhB,IAAuB,IAAID,KAAJ,EAAvB;;AACA,iBAAI,IAAIE,GAAU,GAAC,CAAnB,EAAsBA,GAAG,GAAC,KAAKd,OAAL,CAAac,GAAvC,EAA4CA,GAAG,EAA/C,EACA;AACC,mBAAKZ,UAAL,CAAgBW,GAAhB,EAAqBC,GAArB,IAA4B;AAAA;AAAA,sCAAYA,GAAZ,EAAiBD,GAAjB,EAAsB,KAAKf,UAA3B,CAA5B;AACA;AACD;AACD;;AAGMiB,QAAAA,MAAM,GACb;AACC,cAAG,CAAC;AAAA;AAAA,4CAAaC,QAAb,CAAsBC,MAAvB,IAA+B,CAAC,KAAKnB,UAAL,CAAgBoB,MAAnD,EAA0D;AAC1D,cAAIC,OAAY,GAAG;AAAA;AAAA,4CAAaH,QAAb,CAAsBC,MAAtB,CAA6BG,UAAhD;AACA,cAAIC,KAAmB,GAAG,KAAKC,gBAAL,CAAsBH,OAAO,CAACI,CAA9B,EAAiCJ,OAAO,CAACK,CAAzC,CAA1B,CAHD,CAIO;;AACN,eAAKC,SAAL,CAAeJ,KAAf;AACM,cAAIK,GAAG,GAAG;AAAA;AAAA,4CAAaV,QAAb,CAAsBC,MAAtB,CAA6BU,WAA7B,CAAyCT,MAAzC,CAAgDU,QAA1D,CANP,CAM0E;;AACnE,eAAK9B,UAAL,CAAgBoB,MAAhB,CAAuBW,WAAvB,CAAmCH,GAAnC,EAPP,CAOgD;;;AAC/C;AAAA;AAAA,4CAAaI,QAAb,CAAsB;AAAA;AAAA,sCAAUC,UAAhC,EAA4CF,WAA5C,CAAwDH,GAAxD;AAEA;;AAEMD,QAAAA,SAAS,CAACJ,KAAD,EAChB;AACC,cAAGA,KAAK,IAAIA,KAAK,CAACW,MAAN,GAAe,CAA3B,EACA;AACC,gBAAInB,GAAJ,EAAgBC,GAAhB;AACA,gBAAImB,GAAJ,EAAuBC,GAAvB;AACA,gBAAIC,MAAJ,CAHD,CAIC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AACA,iBAAID,GAAJ,IAAWb,KAAK,CAACxB,SAAjB,EACA;AACC,kBAAG,CAAC,KAAKO,YAAL,CAAkBgC,WAAlB,CAA8BF,GAA9B,CAAJ,EACA;AACCD,gBAAAA,GAAG,GAAGC,GAAG,CAACG,KAAJ,CAAU,GAAV,CAAN;AACAxB,gBAAAA,GAAG,GAAGyB,QAAQ,CAACL,GAAG,CAAC,CAAD,CAAJ,CAAd;AACAnB,gBAAAA,GAAG,GAAGwB,QAAQ,CAACL,GAAG,CAAC,CAAD,CAAJ,CAAd;;AACA,oBAAGpB,GAAG,GAAG,KAAKb,OAAL,CAAaa,GAAnB,IAA0BC,GAAG,GAAG,KAAKd,OAAL,CAAac,GAAhD,EACA;AACC,sBAAG,KAAKZ,UAAL,CAAgBW,GAAhB,KAAsB,KAAKX,UAAL,CAAgBW,GAAhB,EAAqBC,GAArB,CAAzB,EACA;AACC,yBAAKZ,UAAL,CAAgBW,GAAhB,EAAqBC,GAArB,EAA0ByB,QAA1B;;AACAJ,oBAAAA,MAAM,GAAGtB,GAAG,GAAG,GAAN,GAAYC,GAArB;;AACA,yBAAKV,YAAL,CAAkBoC,GAAlB,CAAsBL,MAAtB,EAA8BA,MAA9B;;AACAM,oBAAAA,OAAO,CAACC,GAAR,CAAY,iBAAZ,EAA8BP,MAA9B;AACA;AACD;AACD;AACD;AACD;AACD;;AAEMb,QAAAA,gBAAgB,CAACqB,IAAD,EAAcC,IAAd,EACvB;AACC,cAAIC,KAAY,GAAG,KAAK9C,MAAL,CAAY8C,KAA/B;AACA,cAAIC,KAAY,GAAG,KAAK/C,MAAL,CAAY+C,KAA/B;AACA,cAAIC,IAAS,GAAG,IAAI3D,IAAJ,CAASuD,IAAI,GAACE,KAAd,EAAqBD,IAAI,GAACE,KAA1B,EAAiC;AAAA;AAAA,0CAAYE,OAAZ,GAAsBH,KAAvD,EAA+D;AAAA;AAAA,0CAAYI,OAAZ,GAAsBH,KAArF,CAAhB;AACA,cAAII,EAAO,GAAG,KAAKC,cAAL,CAAoBJ,IAAI,CAACxB,CAAzB,EAA4BwB,IAAI,CAACvB,CAAjC,CAAd;AACA,cAAI4B,EAAO,GAAG,KAAKD,cAAL,CAAoBJ,IAAI,CAACxB,CAAL,GAAOwB,IAAI,CAACM,KAAhC,EAAsCN,IAAI,CAACvB,CAAL,GAAQuB,IAAI,CAACO,MAAnD,CAAd;AACA,cAAIC,GAAiB,GAAG;AAAA;AAAA,+CAAxB;AACA,cAAIrB,GAAJ;;AACA,eAAI,IAAIsB,CAAQ,GAACN,EAAE,CAAC3B,CAApB,EAAuBiC,CAAC,IAAEJ,EAAE,CAAC7B,CAA7B,EAAgCiC,CAAC,EAAjC,EACA;AACC,iBAAI,IAAIC,CAAQ,GAACP,EAAE,CAAC1B,CAApB,EAAuBiC,CAAC,IAAEL,EAAE,CAAC5B,CAA7B,EAAgCiC,CAAC,EAAjC,EACA;AACCvB,cAAAA,GAAG,GAAGsB,CAAC,GAAG,GAAJ,GAAUC,CAAhB;AACAF,cAAAA,GAAG,CAACf,GAAJ,CAAQN,GAAR,EAAaA,GAAb;AACA;AACD;;AACD,iBAAOqB,GAAP;AACA;;AAEMG,QAAAA,iBAAiB,CAACf,IAAD,EAAcC,IAAd,EACxB;AACC,cAAIC,KAAY,GAAG,KAAK9C,MAAL,CAAY8C,KAA/B;AACA,cAAIC,KAAY,GAAG,KAAK/C,MAAL,CAAY+C,KAA/B,CAFD,CAGC;;AACA,cAAIC,IAAS,GAAG,IAAI3D,IAAJ,CAASuD,IAAI,GAACE,KAAd,EAAqBD,IAAI,GAACE,KAA1B,EAAiC;AAAA;AAAA,0CAAYE,OAAZ,GAAsBH,KAAK,GAAC,CAA7D,EAAgE;AAAA;AAAA,0CAAYI,OAAZ,GAAsBH,KAAK,GAAC,CAA5F,CAAhB;AACA,cAAII,EAAO,GAAG,KAAKC,cAAL,CAAoBJ,IAAI,CAACxB,CAAzB,EAA4BwB,IAAI,CAACvB,CAAjC,CAAd;AACA,cAAI4B,EAAO,GAAG,KAAKD,cAAL,CAAoBJ,IAAI,CAACM,KAAzB,EAAgCN,IAAI,CAACO,MAArC,CAAd;AAEA,cAAIC,GAAiB,GAAG;AAAA;AAAA,+CAAxB;AACA,cAAII,OAAJ;AACA,cAAIzB,GAAJ;;AACA,eAAI,IAAIsB,CAAQ,GAACN,EAAE,CAAC3B,CAApB,EAAuBiC,CAAC,IAAEJ,EAAE,CAAC7B,CAA7B,EAAgCiC,CAAC,EAAjC,EACA;AACC,iBAAI,IAAIC,CAAQ,GAACP,EAAE,CAAC1B,CAApB,EAAuBiC,CAAC,IAAEL,EAAE,CAAC5B,CAA7B,EAAgCiC,CAAC,EAAjC,EACA;AACCE,cAAAA,OAAO,GAAG,KAAKC,cAAL,CAAoBJ,CAApB,EAAsBC,CAAtB,CAAV;;AACA,kBAAGV,IAAI,CAACc,QAAL,CAAcF,OAAd,CAAH,EACA;AACCzB,gBAAAA,GAAG,GAAGsB,CAAC,GAAG,GAAJ,GAAUC,CAAhB;AACAF,gBAAAA,GAAG,CAACf,GAAJ,CAAQN,GAAR,EAAaA,GAAb;AACA;AACD;AACD;;AACD,iBAAOqB,GAAP;AACA;;AAEMJ,QAAAA,cAAc,CAAC5B,CAAD,EAAWC,CAAX,EACrB;AACC,cAAIsC,CAAM,GAAG,IAAIzE,IAAJ,EAAb;AACAyE,UAAAA,CAAC,CAACvC,CAAF,GAAMe,QAAQ,CAACf,CAAC,GAAG,KAAKvB,OAAL,CAAa6C,KAAjB,GAAyB,EAA1B,CAAd,CAFD,CAEkD;;AACjDiB,UAAAA,CAAC,CAACtC,CAAF,GAAMc,QAAQ,CAACd,CAAC,GAAG,KAAKxB,OAAL,CAAa8C,KAAjB,GAAuB,CAAC,CAAxB,GAA4B,EAA7B,CAAd,CAHD,CAGqD;;AACpD,iBAAOgB,CAAP;AACA;;AAEMF,QAAAA,cAAc,CAACrC,CAAD,EAAWC,CAAX,EACrB;AACC,cAAIsC,CAAM,GAAG,IAAIzE,IAAJ,EAAb;AACAyE,UAAAA,CAAC,CAACvC,CAAF,GAAM,CAACA,CAAC,GAAE,GAAJ,IAAY,KAAKvB,OAAL,CAAa6C,KAA/B,CAFD,CAE2C;;AAC1CiB,UAAAA,CAAC,CAACtC,CAAF,GAAM,EAAEA,CAAC,GAAG,GAAN,IAAa,KAAKxB,OAAL,CAAa8C,KAAhC,CAHD,CAG4C;;AAC3C,iBAAOgB,CAAP;AACA;;AAGyB,mBAAR9C,QAAQ,GAC1B;AACC,cAAG,CAAC,KAAKL,SAAT,EAAmB;AAAE,iBAAKA,SAAL,GAAiB,IAAI1B,QAAJ,EAAjB;AAAkC;;AACvD,iBAAO,KAAK0B,SAAZ;AACA;;AAvLF,O;;AADqB1B,MAAAA,Q,CAmLL0B,S","sourcesContent":["import { Layers, Node,Rect,Sprite, Vec2 } from \"cc\";\nimport ObjDictionary from \"../../core/dataStructue/ObjDictionary\";\nimport mGameConfig from \"../../utils/MGameConfig\";\nimport { sceneManager } from \"../App\";\nimport LayerEnum from \"./LayerEnum\";\nimport MapGridVO from \"./MapGridVO\";\nimport MapTile from \"./MapTile\";\nimport SceneManager from \"./SceneManager\";\n\nexport default class WorldMap\n{\n\t\n\tprivate _container:Node;\n\tpublic get container():Node\n\t{\n\t\treturn this._container;\n\t}\n \n\t\n\tprivate _gridVO:MapGridVO = new MapGridVO();\n\tpublic get gridVO():MapGridVO\n\t{\n\t\treturn this._gridVO;\n\t}\n\t\n\tprivate _gridTiles:Array<Array<MapTile>>;\n\tpublic get gridTiles():Array<Array<MapTile>>\n\t{\n\t\treturn this._gridTiles;\n\t}\n\t\n\t/**\n\t * 已经加载的Tile \n\t */\t\t\n\tprivate _loadedTiles:ObjDictionary = new ObjDictionary();\n\n\tpublic constructor()\n\t{\n\t\tthis._container = new Node();\n        this._container.layer = Layers.Enum.UI_2D;;\n        this.init();\n\t}\n\t\n\tpublic init():void\n\t{\n\t\t//let bg:Sprite = new Sprite();\n\t\t//bg.loadImage(\"res/bg3.jpg\");\n\t\t//_container.addChild(bg);\n\t\tthis.createTiles();\n\t}\n\tpublic reset(){\n\t\tWorldMap._instance = null;\n\t}\n\t\n\tprivate createTiles():void\n\t{\n\t\tthis._gridTiles = new Array<Array<MapTile>>();\n\t\tfor(let col:number=0; col<this._gridVO.col; col++)\n\t\t{\n\t\t\tthis._gridTiles[col] = new Array<MapTile>();\n\t\t\tfor(let row:number=0; row<this._gridVO.row; row++)\t\t\t\n\t\t\t{\n\t\t\t\tthis._gridTiles[col][row] = new MapTile(row, col, this._container);\n\t\t\t}\n\t\t}\n\t}\n\t\n\n\tpublic update():void\n\t{\n\t\tif(!SceneManager.instance.camera||!this._container.parent)return;\n\t\tlet camView:Rect = SceneManager.instance.camera.cameraView; \n\t\tlet tiles:ObjDictionary = this.getNeedLoadTiles(camView.x, camView.y);\n        // console.log(JSON.stringify(tiles.container)+\"=========================================\");\n\t\tthis.loadTiles(tiles);\n        let vec = SceneManager.instance.camera.focusTarget.parent.position;//actor_layer\n        this._container.parent.setPosition(vec );//map_layer\n\t\tsceneManager.getLayer(LayerEnum.DebugLayer).setPosition(vec);\n\n\t}\n\t\n\tpublic loadTiles(tiles:ObjDictionary):void\n\t{\n\t\tif(tiles && tiles.length > 0)\n\t\t{\n\t\t\tlet col:number, row:number;\n\t\t\tlet arr:Array<string>, key:string;\n\t\t\tlet strKey:string;\n\t\t\t//先卸载  暂不卸载,在动态加载图片显示时,cocos 会非常卡\n\t\t\t// for(key in this._loadedTiles.container)\n\t\t\t// {\n\t\t\t// \tif(!tiles.containsKey(key))\n\t\t\t// \t{\n\t\t\t// \t\tarr = key.split(\"_\");\n\t\t\t// \t\tcol = parseInt(arr[0]);\n\t\t\t// \t\trow = parseInt(arr[1]);\n\t\t\t// \t\tthis._gridTiles[col][row].unloadTile();\n\t\t\t// \t\tstrKey = col + \"_\" + row;\n\t\t\t// \t\tthis._loadedTiles.remove(strKey);\n\t\t\t// \t\tconsole.log(\"loadtiles remove::\",strKey);\n\t\t\t// \t}\n\t\t\t// }\n\t\t\t//再加载\n\t\t\tfor(key in tiles.container)\n\t\t\t{\n\t\t\t\tif(!this._loadedTiles.containsKey(key))\n\t\t\t\t{\n\t\t\t\t\tarr = key.split(\"_\");\n\t\t\t\t\tcol = parseInt(arr[0]);\n\t\t\t\t\trow = parseInt(arr[1]);\n\t\t\t\t\tif(col < this._gridVO.col && row < this._gridVO.row)\n\t\t\t\t\t{\n\t\t\t\t\t\tif(this._gridTiles[col]&&this._gridTiles[col][row])\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis._gridTiles[col][row].loadTile();\n\t\t\t\t\t\t\tstrKey = col + \"_\" + row;\n\t\t\t\t\t\t\tthis._loadedTiles.add(strKey, strKey);\n\t\t\t\t\t\t\tconsole.log(\"loadtiles add::\",strKey);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\t\n\tpublic getNeedLoadTiles(camX:number, camY:number):ObjDictionary\n\t{\n\t\tlet cellW:number = this.gridVO.cellW;\n\t\tlet cellH:number = this.gridVO.cellH;\n\t\tlet rect:Rect = new Rect(camX-cellW, camY+cellH, mGameConfig.DeviceW + cellW, (mGameConfig.DeviceH + cellH));\n\t\tlet p1:Vec2 = this.scenePosToGrid(rect.x, rect.y);\n\t\tlet p2:Vec2 = this.scenePosToGrid(rect.x+rect.width,rect.y- rect.height);\n\t\tlet res:ObjDictionary = new ObjDictionary();\n\t\tlet key:string;\n\t\tfor(let i:number=p1.x; i<=p2.x; i++)\n\t\t{\n\t\t\tfor(let j:number=p1.y; j<=p2.y; j++)\n\t\t\t{\n\t\t\t\tkey = i + \"_\" + j;\n\t\t\t\tres.add(key, key);\n\t\t\t}\n\t\t}\n\t\treturn res;\n\t}\n\t\n\tpublic getNeedLoadTiles1(camX:number, camY:number):ObjDictionary\n\t{\n\t\tlet cellW:number = this.gridVO.cellW;\n\t\tlet cellH:number = this.gridVO.cellH;\n\t\t//let rect:Rectangle = new Rectangle(camX-cellW*0.5, camY-cellH*0.5, mGameConfig.DeviceW + cellW, mGameConfig.DeviceH + cellH);\n\t\tlet rect:Rect = new Rect(camX-cellW, camY-cellH, mGameConfig.DeviceW + cellW*2, mGameConfig.DeviceH + cellH*2);\n\t\tlet p1:Vec2 = this.scenePosToGrid(rect.x, rect.y);\n\t\tlet p2:Vec2 = this.scenePosToGrid(rect.width, rect.height);\n\t\t\n\t\tlet res:ObjDictionary = new ObjDictionary();\n\t\tlet centerP:Vec2;\n\t\tlet key:String;\n\t\tfor(let i:number=p1.x; i<=p2.x; i++)\n\t\t{\n\t\t\tfor(let j:number=p1.y; j<=p2.y; j++)\n\t\t\t{\n\t\t\t\tcenterP = this.gridToScenePos(i,j);\n\t\t\t\tif(rect.contains(centerP))\n\t\t\t\t{\n\t\t\t\t\tkey = i + \"_\" + j;\n\t\t\t\t\tres.add(key, key);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn res;\n\t}\n\t\n\tpublic scenePosToGrid(x:number, y:number):Vec2\n\t{\n\t\tlet p:Vec2 = new Vec2();\n\t\tp.x = parseInt(x / this._gridVO.cellW + \"\");     //列\n\t\tp.y = parseInt(y / this._gridVO.cellH*-1 + \"\");     //行\n\t\treturn p;\n\t}\n\t\n\tpublic gridToScenePos(x:number, y:number):Vec2\n\t{\n\t\tlet p:Vec2 = new Vec2();\n\t\tp.x = (x +0.5) *  this._gridVO.cellW;     //列\n\t\tp.y = -(y + 0.5) * this._gridVO.cellH;     //行\n\t\treturn p;\n\t}\n\t\n\tprivate static _instance:WorldMap\n\tpublic static get instance():WorldMap\n\t{\n\t\tif(!this._instance){ this._instance = new WorldMap(); }\n\t\treturn this._instance;\n\t}\n\t\n}"]}