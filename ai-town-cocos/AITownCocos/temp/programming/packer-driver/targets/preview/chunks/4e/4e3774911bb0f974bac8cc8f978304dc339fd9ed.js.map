{"version":3,"sources":["file:///Users/feiwang/AITown/AITownCocos/assets/src/manager/JietuComponent.ts"],"names":["base64ToUint8Array","base64String","padding","repeat","length","base64","replace","rawData","window","atob","outputArray","Uint8Array","i","charCodeAt","_decorator","Component","Node","Camera","RenderTexture","director","gfx","SpriteFrame","ImageAsset","Sprite","Texture2D","Vec3","Canvas","Log","ccclass","property","postCardSize","width","height","windowSize","upLoadPostcard","TAG","JietuComponent","base64Head","_renderTex","canmove","start","reset","base64HeadSpr","node","on","EventType","TOUCH_START","touchStartHandler","TOUCH_MOVE","touchMOveHandler","TOUCH_END","touchendHandler","update","deltaTime","clickCaptureHandler","capture","createPostcard","size","path","global","camera","targetTexture","scheduleOnce","copyRenderTex","generateUniqueId","Date","now","toString","temp","split","renderTex","arrayBuffer","ArrayBuffer","region","BufferTextureCopy","texOffset","x","y","texExtent","dataview","byteLength","root","device","copyTextureToBuffers","getGFXTexture","toB64","buffer","canvas","document","createElement","Math","floor","ctx","getContext","imageU8Data","rowBytes","rowBytesh","row","sRow","imageData","createImageData","data","putImageData","toDataURL","localStorage","setItem","error","copybase64toSprite","evt","img","Image","texture","src","onload","image","spriteFrame","getComponent","log","Tevt","loca","getLocation","worldPosition"],"mappings":"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","sourcesContent":["import { _decorator, Component, Node, Camera, RenderTexture, director, gfx, SpriteFrame, ImageAsset, Sprite, Texture2D, EventTouch, Vec3, Canvas } from 'cc';\nimport Log from '../../../assets/src/utils/LogUtils'\n\nconst { ccclass, property } = _decorator;\n\nconst postCardSize = { width: 750, height: 1334 }\nconst windowSize = { width: 750, height: 1334 }\nexport const upLoadPostcard = 'upLoadPostcard'\n\nexport function base64ToUint8Array(base64String) {\n    const padding = '='.repeat((4 - base64String.length % 4) % 4);\n        const base64 = (base64String + padding)\n                    .replace(/\\-/g, '+')\n                    .replace(/_/g, '/');\n\n        const rawData = window.atob(base64);\n        const outputArray = new Uint8Array(rawData.length);\n\n        for (let i = 0; i < rawData.length; ++i) {\n            outputArray[i] = rawData.charCodeAt(i);\n        }\n        return outputArray;\n}\n\nconst TAG = 'JietuComponent'\n/**\n * \n */\n@ccclass('JietuComponent')\nexport class JietuComponent extends Component {\n    @property(Camera)\n    camera: Camera = null;\n    @property(Canvas)\n    canvas: Canvas = null;\n    @property(Sprite)\n    base64HeadSpr: Sprite = null;\n\n\n    base64Head;\n    protected _renderTex: RenderTexture = new RenderTexture();\n\n    start() {\n        this._renderTex.reset({ width: 750, height: 1334 });\n        this.base64HeadSpr.node.on(Node.EventType.TOUCH_START, this.touchStartHandler, this);\n        this.base64HeadSpr.node.on(Node.EventType.TOUCH_MOVE, this.touchMOveHandler, this);\n        this.base64HeadSpr.node.on(Node.EventType.TOUCH_END, this.touchendHandler, this);\n    }\n\n    update(deltaTime: number) {\n\n    }\n    /** */\n    clickCaptureHandler() {\n        this.capture(windowSize, \"chatLogImage\");\n    }\n\n    /**生成明信片分享到TG */\n    createPostcard(){\n        this.capture(postCardSize, 'postcard');\n    }\n\n    /**\n     * 将camera 绘制的内容渲染到 指定的 rendertexture,对应的canvas内容将失效,不再更新新的数据;\n     * @returns \n     */\n    capture(size: {width: number, height: number}, path: string): string {\n        (window as any).global = window\n        let camera = this.camera;\n        camera.targetTexture = this._renderTex;\n        this.scheduleOnce(() => {\n            //this._renderTex.reset(size)\n            this.base64Head = this.copyRenderTex(this._renderTex);\n            camera.targetTexture = null;\n            const generateUniqueId = `id_${Date.now().toString(36)}`;\n            let temp = this.base64Head.split(\"data:image/jpeg;base64,\")[1];\n\n            //this.node.emit(message,\"data:image/jpeg;base64,iVBORw0KGgoAAAANSUhEUgAAABYAAAAoCAYAAAD6xArmAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAJDSURBVHgB7VdNaxNBGH5md0sJ2mpLNUlT6qEq1KpEhGpJPVSaglUPbcAcRKxSvHgSPBXBX6BnUfCmEBDFqycPildBFPET+pE2pR9pWhLytduZKZvukm1mpjSXkgeWeWfmnWfeeebdN1lSnP9ioQ7QUCc0iBvEisRff/xGcyiCpuAAfxLvPkAWRPSCMPIL0QmYpglN05Cf+wwZCKUInzqBxw8nuc3I+wbjkIGUxlMP7qDT38HtX3+n+Sn2hJjh/eunFfvmvUdCf2liJonP18ztP/9nhf5K6Xa29zhvmdYiOZSIT/f2VOxnL9/U9CWq9ZjlM8PJnm58/5TY0W+f1wrnhbUdasGeETsvbHQ4UtNX6fKOha8jmVriNl1X01cp4vnFZd4eFsigRDx4dRKWtXW42LUhob+UFOzS+odvc2L2Wmf+fRQtkYs4On6/Eu2LJ1MyS8TErP6m19a5PRqNID42AhkYtSaZBJcuhvnTHQrwuiwLUq//bkbq28+tHejvmUXLIdOSEFLRlM/RvhO2j6+9DQcCHdB1vYqYvB27TBnYwp0Cd85t2yyQluBRnJu4gdaQvzriUr6A3YBtkVvNoFzIe84b4Vvj2z2TRqO5j+0ac9hE03HQf4RGG/Am1rs6oekEZtlytS5uxxztYXU5jQ2agu25LFrpiO5FnHj+CiowyyZy2SxvjSYDsbtx9J0/U028ns5AFXbGFAtFLMwkvYlHYldc6WWnFuvbaeUcLxVLWEymsLaShr8riP6hAc/NSePjxsYmos7ZM/x85v8AAAAASUVORK5CYII=\");\n\n           \n        }, 1)\n        return \"\";\n    }\n\n\n\n    /**\n     * 将rendertexture 中的内容复制出来\n     * @param renderTex \n     * @returns \n     */\n    copyRenderTex(renderTex: RenderTexture): string {\n\n        let arrayBuffer = new ArrayBuffer(renderTex.width * renderTex.height * 4);\n        let region = new gfx.BufferTextureCopy();\n        region.texOffset.x = 0;\n        region.texOffset.y = 0;\n        region.texExtent.width = renderTex.width;\n        region.texExtent.height = renderTex.height;\n        let dataview = new Uint8Array(arrayBuffer, 0, arrayBuffer.byteLength);\n        // console.log(dataview);[0,0,0,0,0,0,0,0,0,0,0,,,]\n        //获取到纹理数据\n        director.root.device.copyTextureToBuffers(renderTex.getGFXTexture(), [dataview], [region]);\n        // director.root.device.copyFramebufferToBuffer(renderTex.window.framebuffer, arrayBuffer, [region]);\n        // console.log(dataview);[0,0,0,255,0,0,0,255,0,0,0,255,0,0,0,255,0,0,0,255,0,0,0,255,0,0,0,255,,,,]\n\n        return this.toB64(dataview.buffer);\n    }\n\n    /**\n     * 通过htmlcanvas ,将纹理缓冲绘制到canvas,\n     * 将canvas 上图片转换为base64 数据;\n     * @param arrayBuffer \n     * @returns \n     */\n    toB64(arrayBuffer: ArrayBuffer): string {\n        let canvas = document.createElement('canvas');\n        let width = canvas.width = Math.floor(750);\n        let height = canvas.height = Math.floor(1334);\n        let ctx = canvas.getContext('2d');\n        let imageU8Data = new Uint8Array(arrayBuffer);\n        let rowBytes = width * 4;\n        let rowBytesh = height * 4;\n        for (let row = 0; row < rowBytesh; row++) {\n            let sRow = height - 1 - row;\n            let imageData = ctx.createImageData(width, 1);\n            let start = sRow * rowBytes;\n            for (let i = 0; i < rowBytes; i++) {\n                imageData.data[i] = imageU8Data[start + i];\n            }\n            ctx.putImageData(imageData, 0, row);\n        }\n        var base64 = canvas.toDataURL(\"image/jpeg\", 0.1); //压缩语句\n        try {\n            localStorage.setItem('base64Head', base64)\n        } catch (error) {\n\n        }\n        // console.log('base64', base64)\n        return base64;\n\n    }\n\n\n    public copybase64toSprite(evt) {\n        let img = new Image();\n        let texture = new Texture2D();\n        img.src = this.base64Head;\n        img.onload = () => {\n            texture.image = new ImageAsset(img);\n            const spriteFrame = new SpriteFrame();\n            spriteFrame.texture = texture;\n            this.base64HeadSpr.getComponent(Sprite).spriteFrame = spriteFrame;\n            this.scheduleOnce(() => {\n                Log.log(TAG,this.base64HeadSpr)\n            },)\n        }\n    }\n    public canmove: boolean = false;\n    public touchStartHandler(Tevt) {\n        this.canmove = true;\n    }\n\n    public touchMOveHandler(Tevt: EventTouch) {\n        let loca = Tevt.getLocation();\n        if (this.canmove) {\n            // this.base64HeadSpr.node.position = new Vec3(loca.x,loca.y);\n            this.base64HeadSpr.node.worldPosition = new Vec3(loca.x, loca.y);\n        }\n    }\n    touchendHandler(evt) {\n        this.canmove = false;\n    }\n\n}\n\n\n"]}