{"version":3,"sources":["file:///Users/feiwang/cutepet/assets/resources/ui/jietu/JietuComponent.ts"],"names":["base64ToUint8Array","base64String","padding","repeat","length","base64","replace","rawData","window","atob","outputArray","Uint8Array","i","charCodeAt","_decorator","Component","Node","Camera","RenderTexture","director","gfx","SpriteFrame","ImageAsset","Sprite","Texture2D","Vec3","Canvas","WASManager","ccclass","property","postCardSize","width","height","windowSize","upLoadPostcard","JietuComponent","base64Head","_renderTex","canmove","start","reset","base64HeadSpr","node","on","EventType","TOUCH_START","touchStartHandler","TOUCH_MOVE","touchMOveHandler","TOUCH_END","touchendHandler","update","deltaTime","clickCaptureHandler","capture","createPostcard","size","path","global","camera","targetTexture","scheduleOnce","copyRenderTex","generateUniqueId","Date","now","toString","temp","split","setConfig","arrayBuffer","uploadTextureToS3","renderTex","ArrayBuffer","region","BufferTextureCopy","texOffset","x","y","texExtent","dataview","byteLength","root","device","copyTextureToBuffers","getGFXTexture","toB64","buffer","canvas","document","createElement","Math","floor","ctx","getContext","imageU8Data","rowBytes","rowBytesh","row","sRow","imageData","createImageData","data","putImageData","toDataURL","localStorage","setItem","error","copybase64toSprite","evt","img","Image","texture","src","onload","image","spriteFrame","getComponent","console","log","Tevt","loca","getLocation","worldPosition"],"mappings":"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","sourcesContent":["import { _decorator, Component, Node, Camera, RenderTexture, director, gfx, SpriteFrame, ImageAsset, Sprite, Texture2D, EventTouch, Vec3, Canvas } from 'cc';\nimport { postShare } from '../../../src/manager/RequestManager';\nimport AxiosManager from '../../../src/manager/AxiosManager';\nimport { modelMgr, observer } from '../../../src/game/App';\nimport { showMsg2 } from '../../../src/core/message/MessageManager';\nimport WASManager from '../../../src/manager/WASManager';\n\nconst { ccclass, property } = _decorator;\n\nconst postCardSize = { width: 750, height: 1334 }\nconst windowSize = { width: 750, height: 1334 }\nexport const upLoadPostcard = 'upLoadPostcard'\n\nexport function base64ToUint8Array(base64String) {\n    const padding = '='.repeat((4 - base64String.length % 4) % 4);\n        const base64 = (base64String + padding)\n                    .replace(/\\-/g, '+')\n                    .replace(/_/g, '/');\n\n        const rawData = window.atob(base64);\n        const outputArray = new Uint8Array(rawData.length);\n\n        for (let i = 0; i < rawData.length; ++i) {\n            outputArray[i] = rawData.charCodeAt(i);\n        }\n        return outputArray;\n}\n\n/**\n * \n */\n@ccclass('JietuComponent')\nexport class JietuComponent extends Component {\n    @property(Camera)\n    camera: Camera = null;\n    @property(Canvas)\n    canvas: Canvas = null;\n    @property(Sprite)\n    base64HeadSpr: Sprite = null;\n\n\n    base64Head;\n    protected _renderTex: RenderTexture = new RenderTexture();\n\n    start() {\n        this._renderTex.reset({ width: 750, height: 1334 });\n        this.base64HeadSpr.node.on(Node.EventType.TOUCH_START, this.touchStartHandler, this);\n        this.base64HeadSpr.node.on(Node.EventType.TOUCH_MOVE, this.touchMOveHandler, this);\n        this.base64HeadSpr.node.on(Node.EventType.TOUCH_END, this.touchendHandler, this);\n    }\n\n    update(deltaTime: number) {\n\n    }\n    /** */\n    clickCaptureHandler() {\n        this.capture(windowSize, \"chatLogImage\");\n    }\n\n    /**生成明信片分享到TG */\n    createPostcard(){\n        this.capture(postCardSize, 'postcard');\n    }\n\n    /**\n     * 将camera 绘制的内容渲染到 指定的 rendertexture,对应的canvas内容将失效,不再更新新的数据;\n     * @returns \n     */\n    capture(size: {width: number, height: number}, path: string): string {\n        (window as any).global = window\n        let camera = this.camera;\n        camera.targetTexture = this._renderTex;\n        this.scheduleOnce(() => {\n            //this._renderTex.reset(size)\n            this.base64Head = this.copyRenderTex(this._renderTex);\n            camera.targetTexture = null;\n            const generateUniqueId = `id_${Date.now().toString(36)}`;\n            let temp = this.base64Head.split(\"data:image/jpeg;base64,\")[1];\n            WASManager.setConfig();\n            const arrayBuffer = base64ToUint8Array(temp)\n            WASManager.uploadTextureToS3(arrayBuffer, 'catoss', `${path}/${generateUniqueId}.jpg`);\n\n            //this.node.emit(message,\"data:image/jpeg;base64,iVBORw0KGgoAAAANSUhEUgAAABYAAAAoCAYAAAD6xArmAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAJDSURBVHgB7VdNaxNBGH5md0sJ2mpLNUlT6qEq1KpEhGpJPVSaglUPbcAcRKxSvHgSPBXBX6BnUfCmEBDFqycPildBFPET+pE2pR9pWhLytduZKZvukm1mpjSXkgeWeWfmnWfeeebdN1lSnP9ioQ7QUCc0iBvEisRff/xGcyiCpuAAfxLvPkAWRPSCMPIL0QmYpglN05Cf+wwZCKUInzqBxw8nuc3I+wbjkIGUxlMP7qDT38HtX3+n+Sn2hJjh/eunFfvmvUdCf2liJonP18ztP/9nhf5K6Xa29zhvmdYiOZSIT/f2VOxnL9/U9CWq9ZjlM8PJnm58/5TY0W+f1wrnhbUdasGeETsvbHQ4UtNX6fKOha8jmVriNl1X01cp4vnFZd4eFsigRDx4dRKWtXW42LUhob+UFOzS+odvc2L2Wmf+fRQtkYs4On6/Eu2LJ1MyS8TErP6m19a5PRqNID42AhkYtSaZBJcuhvnTHQrwuiwLUq//bkbq28+tHejvmUXLIdOSEFLRlM/RvhO2j6+9DQcCHdB1vYqYvB27TBnYwp0Cd85t2yyQluBRnJu4gdaQvzriUr6A3YBtkVvNoFzIe84b4Vvj2z2TRqO5j+0ac9hE03HQf4RGG/Am1rs6oekEZtlytS5uxxztYXU5jQ2agu25LFrpiO5FnHj+CiowyyZy2SxvjSYDsbtx9J0/U028ns5AFXbGFAtFLMwkvYlHYldc6WWnFuvbaeUcLxVLWEymsLaShr8riP6hAc/NSePjxsYmos7ZM/x85v8AAAAASUVORK5CYII=\");\n\n           \n        }, 1)\n        return \"\";\n    }\n\n\n\n    /**\n     * 将rendertexture 中的内容复制出来\n     * @param renderTex \n     * @returns \n     */\n    copyRenderTex(renderTex: RenderTexture): string {\n\n        let arrayBuffer = new ArrayBuffer(renderTex.width * renderTex.height * 4);\n        let region = new gfx.BufferTextureCopy();\n        region.texOffset.x = 0;\n        region.texOffset.y = 0;\n        region.texExtent.width = renderTex.width;\n        region.texExtent.height = renderTex.height;\n        let dataview = new Uint8Array(arrayBuffer, 0, arrayBuffer.byteLength);\n        // console.log(dataview);[0,0,0,0,0,0,0,0,0,0,0,,,]\n        //获取到纹理数据\n        director.root.device.copyTextureToBuffers(renderTex.getGFXTexture(), [dataview], [region]);\n        // director.root.device.copyFramebufferToBuffer(renderTex.window.framebuffer, arrayBuffer, [region]);\n        // console.log(dataview);[0,0,0,255,0,0,0,255,0,0,0,255,0,0,0,255,0,0,0,255,0,0,0,255,0,0,0,255,,,,]\n\n        return this.toB64(dataview.buffer);\n    }\n\n    /**\n     * 通过htmlcanvas ,将纹理缓冲绘制到canvas,\n     * 将canvas 上图片转换为base64 数据;\n     * @param arrayBuffer \n     * @returns \n     */\n    toB64(arrayBuffer: ArrayBuffer): string {\n        let canvas = document.createElement('canvas');\n        let width = canvas.width = Math.floor(750);\n        let height = canvas.height = Math.floor(1334);\n        let ctx = canvas.getContext('2d');\n        let imageU8Data = new Uint8Array(arrayBuffer);\n        let rowBytes = width * 4;\n        let rowBytesh = height * 4;\n        for (let row = 0; row < rowBytesh; row++) {\n            let sRow = height - 1 - row;\n            let imageData = ctx.createImageData(width, 1);\n            let start = sRow * rowBytes;\n            for (let i = 0; i < rowBytes; i++) {\n                imageData.data[i] = imageU8Data[start + i];\n            }\n            ctx.putImageData(imageData, 0, row);\n        }\n        var base64 = canvas.toDataURL(\"image/jpeg\", 0.1); //压缩语句\n        try {\n            localStorage.setItem('base64Head', base64)\n        } catch (error) {\n\n        }\n        // console.log('base64', base64)\n        return base64;\n\n    }\n\n\n    public copybase64toSprite(evt) {\n        let img = new Image();\n        let texture = new Texture2D();\n        img.src = this.base64Head;\n        img.onload = () => {\n            texture.image = new ImageAsset(img);\n            const spriteFrame = new SpriteFrame();\n            spriteFrame.texture = texture;\n            this.base64HeadSpr.getComponent(Sprite).spriteFrame = spriteFrame;\n            this.scheduleOnce(() => {\n                console.log(this.base64HeadSpr)\n            },)\n        }\n    }\n    public canmove: boolean = false;\n    public touchStartHandler(Tevt) {\n        this.canmove = true;\n    }\n\n    public touchMOveHandler(Tevt: EventTouch) {\n        let loca = Tevt.getLocation();\n        if (this.canmove) {\n            // this.base64HeadSpr.node.position = new Vec3(loca.x,loca.y);\n            this.base64HeadSpr.node.worldPosition = new Vec3(loca.x, loca.y);\n        }\n    }\n    touchendHandler(evt) {\n        this.canmove = false;\n    }\n\n}\n\n\n"]}